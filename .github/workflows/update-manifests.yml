name: Update Shiny App Manifests

on:
  push:
    branches: [dev, automate-manifests]
  workflow_dispatch:

concurrency:
  group: update-manifests-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-manifests:
    # Skip commits made by this workflow to prevent infinite loops
    if: github.event.head_commit.author.username != 'github-actions[bot]'
    runs-on: ubuntu-24.04
    container: r-base:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            git \
            libssl-dev \
            libcurl4-gnutls-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev
          rm -rf /var/lib/apt/lists/*

      - name: Install R packages
        run: |
          Rscript -e '
          options(HTTPUserAgent = sprintf("R/%s R (%s)", getRversion(), paste(getRversion(), R.version["platform"], R.version["arch"], R.version["os"])))
          install.packages(c("rsconnect", "renv"), repos = c(CRAN = "https://p3m.dev/cran/__linux__/bookworm/latest"))
          '

      - name: Regenerate manifests
        run: |
          Rscript -e '
          # Set HTTPUserAgent for P3M binary packages
          options(HTTPUserAgent = sprintf("R/%s R (%s)", getRversion(), paste(getRversion(), R.version["platform"], R.version["arch"], R.version["os"])))

          # Set up named repositories for renv
          options(repos = c(
            CRAN = "https://p3m.dev/cran/__linux__/bookworm/latest"
          ))

          app_dirs <- c("inst/apps/connect", "inst/apps/workbench")
          for (app_dir in app_dirs) {
            message("Generating manifest for: ", app_dir)

            # Snapshot current dependencies to renv.lock, skip validation
            renv::snapshot(project = app_dir, prompt = FALSE, force = TRUE)

            # Generate manifest.json
            rsconnect::writeManifest(appDir = app_dir)
          }
          '

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          title: "Update Shiny app manifests"
          body: |
            Automated update of `manifest.json` and `renv.lock` for Shiny apps in `inst/apps/`.

            Triggered by push to `${{ github.ref_name }}`.
          branch: auto/update-manifests
          commit-message: "Update Shiny app manifests and renv.lock files"
          delete-branch: true
