name: Update Shiny App Manifests

on:
  push:
    branches: [dev, automate-manifests]
  workflow_dispatch:

concurrency:
  group: update-manifests-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-manifests:
    # Skip commits made by this workflow to prevent infinite loops
    if: github.event.head_commit.author.username != 'github-actions[bot]'
    runs-on: ubuntu-24.04
    container: r-base:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            git \
            libssl-dev \
            libcurl4-gnutls-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev
          rm -rf /var/lib/apt/lists/*

      - name: Install GitHub CLI
        run: |
          apt-get update
          apt-get install -y curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt-get update
          apt-get install -y gh
          rm -rf /var/lib/apt/lists/*

      - name: Install R packages
        run: |
          Rscript -e '
          options(HTTPUserAgent = sprintf("R/%s R (%s)", getRversion(), paste(getRversion(), R.version["platform"], R.version["arch"], R.version["os"])))
          install.packages(c("rsconnect", "renv"), repos = c(CRAN = "https://p3m.dev/cran/__linux__/bookworm/latest"))
          '

      - name: Regenerate manifests
        run: |
          Rscript -e '
          # Set HTTPUserAgent for P3M binary packages
          options(HTTPUserAgent = sprintf("R/%s R (%s)", getRversion(), paste(getRversion(), R.version["platform"], R.version["arch"], R.version["os"])))

          # Set up named repositories for renv
          options(repos = c(
            CRAN = "https://p3m.dev/cran/__linux__/bookworm/latest"
          ))

          app_dirs <- c("inst/apps/connect", "inst/apps/workbench")
          for (app_dir in app_dirs) {
            message("Generating manifest for: ", app_dir)

            # Snapshot current dependencies to renv.lock, skip validation
            renv::snapshot(project = app_dir, prompt = FALSE, force = TRUE)

            # Generate manifest.json
            rsconnect::writeManifest(appDir = app_dir)
          }
          '

      - name: Check for changes
        id: changes
        run: |
          MANIFEST_FILES="inst/apps/connect/manifest.json inst/apps/connect/renv.lock inst/apps/workbench/manifest.json inst/apps/workbench/renv.lock"
          if git diff --quiet -- $MANIFEST_FILES; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with updated manifests
        if: steps.changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto/update-manifests-$(date +%Y%m%d-%H%M%S)"
          TARGET="${{ github.ref_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add inst/apps/connect/manifest.json inst/apps/connect/renv.lock \
                  inst/apps/workbench/manifest.json inst/apps/workbench/renv.lock
          git commit -m "Update Shiny app manifests and renv.lock files"
          git push origin "$BRANCH"

          gh pr create \
            --base "$TARGET" \
            --head "$BRANCH" \
            --title "Update Shiny app manifests" \
            --body "Automated update of \`manifest.json\` and \`renv.lock\` for Shiny apps in \`inst/apps/\`.

          Triggered by push to \`$TARGET\`."
