name: Update Shiny App Manifests

on:
  push:
    branches: [dev, automate-manifests]
  workflow_dispatch:

concurrency:
  group: update-manifests-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-manifests:
    # Skip commits made by this workflow to prevent infinite loops
    if: github.event.head_commit.author.username != 'github-actions[bot]'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.5.2"
          extra-repositories: "https://p3m.dev/cran/__linux__/noble/latest"

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rsconnect, any::renv, any::devtools

      - name: Install chronicle.reports with dependencies
        run: |
          Rscript -e 'devtools::install(dependencies = TRUE, upgrade = FALSE)'

      - name: Regenerate manifests
        run: |
          Rscript -e '
          app_dirs <- c("inst/apps/connect", "inst/apps/workbench")
          for (app_dir in app_dirs) {
            message("Generating manifest for: ", app_dir)
            rsconnect::writeManifest(appDir = app_dir)
          }
          '

      - name: Check for changes
        id: changes
        run: |
          MANIFEST_FILES="inst/apps/connect/manifest.json inst/apps/connect/renv.lock inst/apps/workbench/manifest.json inst/apps/workbench/renv.lock"
          if git diff --quiet -- $MANIFEST_FILES; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with updated manifests
        if: steps.changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto/update-manifests-$(date +%Y%m%d-%H%M%S)"
          TARGET="${{ github.ref_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add inst/apps/connect/manifest.json inst/apps/connect/renv.lock \
                  inst/apps/workbench/manifest.json inst/apps/workbench/renv.lock
          git commit -m "Update Shiny app manifests and renv.lock files"
          git push origin "$BRANCH"

          gh pr create \
            --base "$TARGET" \
            --head "$BRANCH" \
            --title "Update Shiny app manifests" \
            --body "Automated update of \`manifest.json\` and \`renv.lock\` for Shiny apps in \`inst/apps/\`.

          Triggered by push to \`$TARGET\`."
