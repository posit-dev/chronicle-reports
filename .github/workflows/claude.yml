---
name: Claude PR Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  pull_request:
    # For testing, run when workflow file is changed
    paths:
      - '.github/workflows/claude.yml'

concurrency:
  # Only cancel in-progress runs for pull_request events, this prevents cancelling workflows against main or tags
  # A pull_request will reuse the same group thus enabling cancelation, all others receive a unique run_id
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  claude-code-action:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      packages: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Generate token for GitHub App
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.POSIT_CHRONICLE_APP_ID }}
          private-key: ${{ secrets.POSIT_CHRONICLE_PEM }}
          permission-actions: read
          permission-contents: write
          permission-pull-requests: write
          permission-issues: write

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ vars.PLATFORM_AWS_ACCOUNT }}:role/gha-claude-code
          role-session-name: ${{ github.triggering_actor }}
          aws-region: us-east-2

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: true
          github_token: ${{ steps.generate-token.outputs.token }}
          branch_prefix: "claude-"
          additional_permissions: "actions: read"
          track_progress: true
          prompt: |
            You are a helpful AI assistant for code reviews and issue triage.
            Respond to comments and issues that mention you with relevant code suggestions or triage actions.
            If you cannot assist, politely inform the user. In your responses, don't be overly complimentary.
            Stick to the facts and provide actionable advice. 
          claude_args: |
            --model us.anthropic.claude-opus-4-5-20251101-v1:0
            --fallback-model us.anthropic.claude-haiku-4-5-20251001-v1:0
            --allowedTools Bash,mcp__github__create_pull_request,mcp__github__create_issue,mcp__github__search_issues,mcp__github__update_issue,mcp__github__create_pending_pull_request_review,mcp__github__add_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diff,mcp__github__add_sub_issue
